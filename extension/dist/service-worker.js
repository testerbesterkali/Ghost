(()=>{"use strict";const e=new Map;class t{patterns;constructor(){this.patterns=[{type:"EMAIL",regex:/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g},{type:"PHONE",regex:/(?:\+?1[-.\s]?)?(?:\(?\d{3}\)?[-.\s]?)?\d{3}[-.\s]?\d{4}/g},{type:"SSN",regex:/\b\d{3}[-.\s]?\d{2}[-.\s]?\d{4}\b/g},{type:"CREDIT_CARD",regex:/\b(?:4\d{3}|5[1-5]\d{2}|3[47]\d{2}|6(?:011|5\d{2}))[-.\s]?\d{4}[-.\s]?\d{4}[-.\s]?\d{4}\b/g},{type:"IP_ADDRESS",regex:/\b(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\b/g},{type:"AUTH_TOKEN",regex:/(?:Bearer\s+[A-Za-z0-9\-._~+/]+=*|(?:api[_-]?key|token|secret|password|auth)[=:]\s*[^\s&"']+)/gi},{type:"DOB",regex:/\b(?:0[1-9]|1[0-2])[/\-.](?:0[1-9]|[12]\d|3[01])[/\-.](?:19|20)\d{2}\b/g}]}scrub(e){if(!e)return e;const t=this.detect(e);if(0===t.length)return e;t.sort((e,t)=>t.start-e.start);let a=e;for(const e of t){const t=this.getReplacement(e.type,e.value);a=a.slice(0,e.start)+t+a.slice(e.end)}return a}detect(e){const t=[];for(const a of this.patterns){let n;for(a.regex.lastIndex=0;null!==(n=a.regex.exec(e));)t.push({type:a.type,value:n[0],start:n.index,end:n.index+n[0].length})}return this.removeOverlaps(t)}containsPii(e){return this.detect(e).length>0}getReplacement(t,a){e.has(t)||e.set(t,new Map);const n=e.get(t),s=a.toLowerCase().replace(/[\s\-.]/g,"");return n.has(s)||n.set(s,n.size+1),`[${t}_${n.get(s)}]`}removeOverlaps(e){if(e.length<=1)return e;e.sort((e,t)=>e.start-t.start||t.end-e.end);const t=[e[0]];for(let a=1;a<e.length;a++){const n=t[t.length-1];e[a].start>=n.end?t.push(e[a]):e[a].end-e[a].start>n.end-n.start&&(t[t.length-1]=e[a])}return t}static resetCounters(){e.clear()}}const a={data_entry:439041101,navigation:725372254,communication:1011703407,research:1298034544,approval:1584361601,file_operation:1869644178,authentication:1887539875,configuration:2173871028,data_extraction:2460202181,workflow_transition:2746533334,error_handling:3032864487,unknown:3319195640};class n{encode(e){const{label:t,confidence:a}=this.classify(e);return{label:t,confidence:a,vector:this.generateVector(t,e)}}classify(e){switch(e.eventType){case"user_int":return this.classifyUserInteraction(e);case"dom_mut":return this.classifyDomMutation(e);case"network":return this.classifyNetworkEvent(e);case"error":return{label:"error_handling",confidence:.9};default:return{label:"unknown",confidence:.1}}}classifyUserInteraction(e){const t=e.payload.action,a=e.payload.target,n=a?.tagName||"",s=a?.aria?.role||"",i=a?.inputType||"";if("input"===t||"paste"===t)return"password"===i||"email"===i?{label:"authentication",confidence:.85}:{label:"data_entry",confidence:.9};if("navigate"===t)return{label:"navigation",confidence:.95};if("click"===t){if("a"===n)return{label:"navigation",confidence:.85};if("button"===n||"button"===s||"submit"===i)return a?.formId?{label:"data_entry",confidence:.8}:{label:"workflow_transition",confidence:.7};if("checkbox"===i||"radio"===i)return{label:"configuration",confidence:.75}}return"select"===t?{label:"data_entry",confidence:.85}:"copy"===t?{label:"data_extraction",confidence:.8}:"scroll"===t?{label:"research",confidence:.5}:"focus"===t?{label:"navigation",confidence:.4}:{label:"unknown",confidence:.2}}classifyDomMutation(e){const t=e.payload.mutations||[];return 0===t.length?{label:"unknown",confidence:.1}:t.reduce((e,t)=>e+t.addedNodes+t.removedNodes,0)>20?{label:"navigation",confidence:.6}:t.filter(e=>["input","textarea","select"].includes(e.target.tagName)||null!==e.target.formId).length>0?{label:"data_entry",confidence:.5}:{label:"workflow_transition",confidence:.4}}classifyNetworkEvent(e){const t=e.payload.method?.toUpperCase()||"GET",a=e.payload.url||"",n=e.payload.statusCode||0;return"POST"===t||"PUT"===t||"PATCH"===t?a.includes("auth")||a.includes("login")||a.includes("token")?{label:"authentication",confidence:.85}:a.includes("message")||a.includes("email")||a.includes("send")?{label:"communication",confidence:.75}:{label:"data_entry",confidence:.7}:"DELETE"===t?{label:"workflow_transition",confidence:.7}:a.includes("search")||a.includes("query")?{label:"research",confidence:.7}:a.includes("export")||a.includes("download")?{label:"data_extraction",confidence:.75}:n>=400?{label:"error_handling",confidence:.6}:{label:"navigation",confidence:.4}}generateVector(e,t){const n=a[e],s=new Array(128);let i=n;for(let e=0;e<128;e++)i=1103515245*i+12345&2147483647,s[e]=.5*(i/2147483647*2-1);const r=this.extractFeatures(t);for(let e=0;e<r.length&&e<128;e++)s[e]=.7*s[e]+.3*r[e];const o=Math.sqrt(s.reduce((e,t)=>e+t*t,0));if(o>0)for(let e=0;e<128;e++)s[e]=Math.round(s[e]/o*1e4)/1e4;return s}extractFeatures(e){const t=[],a=["click","input","scroll","navigate","focus","select","copy","paste"],n=a.indexOf(e.payload.action||"");t.push(n>=0?n/a.length:0);const s=e.payload.target?.tagName||"";t.push(this.hashToFloat(s));const i=e.payload.target?.domPath||[];t.push(Math.min(i.length/20,1));const r=e.payload.target?.position;r?(t.push(r.relativeX),t.push(r.relativeY)):(t.push(0),t.push(0));const o=["GET","POST","PUT","PATCH","DELETE"],c=o.indexOf(e.payload.method?.toUpperCase()||"");for(t.push(c>=0?c/o.length:0),t.push((e.payload.statusCode||0)/600);t.length<128;)t.push(0);return t.slice(0,128)}hashToFloat(e){let t=0;for(let a=0;a<e.length;a++)t=31*t+e.charCodeAt(a)&4294967295;return(2147483647&t)/2147483647}}class s{TIMESTAMP_NOISE_SECONDS=30;FALSE_POSITIVE_RATE=.1;BUCKET_SIZE_MINUTES=5;anonymizeTimestamp(e){const t=this.laplacianNoise(1e3*this.TIMESTAMP_NOISE_SECONDS),a=new Date(e+t),n=a.getMinutes(),s=Math.floor(n/this.BUCKET_SIZE_MINUTES)*this.BUCKET_SIZE_MINUTES;return a.setMinutes(s,0,0),a.toISOString()}randomizedResponse(e){return Math.random()<this.FALSE_POSITIVE_RATE?!e:e}addNoiseToNumber(e,t=1){const a=this.laplacianNoise(t);return Math.round(e+a)}perturbVector(e,t=1){const a=Math.sqrt(2)/t;return e.map(e=>{const t=this.gaussianNoise(0,a);return Math.round(1e4*(e+t))/1e4})}async generateSessionFingerprint(e,t,a){const n=`${e}:${t}:${Math.floor(a/9e5)}`,s=new TextEncoder,i=await crypto.subtle.importKey("raw",s.encode(e),{name:"HMAC",hash:"SHA-256"},!1,["sign"]),r=await crypto.subtle.sign("HMAC",i,s.encode(n));return Array.from(new Uint8Array(r)).map(e=>e.toString(16).padStart(2,"0")).join("")}generateStructuralHash(e,t){const a=`${e.join(">")}:${t}`;return this.fnv1a(a).toString(16).padStart(8,"0")}generateElementSignature(e,t,a){return`${a}${e?`[${e}]`:""}@${t.slice(-3).join(">")}`}laplacianNoise(e){const t=Math.random()-.5;return-e*Math.sign(t)*Math.log(1-2*Math.abs(t))}gaussianNoise(e,t){const a=Math.random(),n=Math.random();return Math.sqrt(-2*Math.log(a))*Math.cos(2*Math.PI*n)*t+e}fnv1a(e){let t=2166136261;for(let a=0;a<e.length;a++)t^=e.charCodeAt(a),t=16777619*t>>>0;return t}}class i{piiScrubber;intentEncoder;differentialPrivacy;sequenceCounter=0;orgId;deviceId;userId;constructor(e,a,i){this.piiScrubber=new t,this.intentEncoder=new n,this.differentialPrivacy=new s,this.orgId=e,this.deviceId=a,this.userId=i}async process(e){const t=this.scrubEvent(e),a=this.intentEncoder.encode(t),n=this.differentialPrivacy.perturbVector(a.vector),s=this.differentialPrivacy.anonymizeTimestamp(Date.now()),i=await this.differentialPrivacy.generateSessionFingerprint(this.deviceId,this.userId,Date.now()),r=e.payload.target?.domPath||[],o=e.payload.target?.tagName||"",c=this.differentialPrivacy.generateStructuralHash(r,o),l=e.payload.target?this.differentialPrivacy.generateElementSignature(e.payload.target.aria.role,r,o):null;return this.sequenceCounter++,{sessionFingerprint:i,timestampBucket:s,intentVector:n,structuralHash:c,orgId:this.orgId,eventType:e.eventType,intentLabel:a.label,intentConfidence:Math.round(100*a.confidence)/100,elementSignature:l,sequenceNumber:this.sequenceCounter}}scrubEvent(e){const t=structuredClone(e);if(t.payload.value&&(t.payload.value=this.piiScrubber.scrub(t.payload.value)),t.payload.message&&(t.payload.message=this.piiScrubber.scrub(t.payload.message)),t.payload.target?.textPreview&&(t.payload.target.textPreview=this.piiScrubber.scrub(t.payload.target.textPreview)),t.payload.mutations)for(const e of t.payload.mutations)e.oldValue&&(e.oldValue=this.piiScrubber.scrub(e.oldValue)),e.newValue&&(e.newValue=this.piiScrubber.scrub(e.newValue));return t.payload.url&&this.piiScrubber.containsPii(t.payload.url)&&(t.payload.url=this.piiScrubber.scrub(t.payload.url)),t.context.url=this.hashUrl(t.context.url),t}hashUrl(e){try{const t=new URL(e),a=this.fnv1a(t.pathname+t.search);return`${t.origin}/${a.toString(16)}`}catch{return"[INVALID_URL]"}}fnv1a(e){let t=2166136261;for(let a=0;a<e.length;a++)t^=e.charCodeAt(a),t=16777619*t>>>0;return t}reset(){this.sequenceCounter=0,t.resetCounters()}}const r={endpoint:"",apiKey:"",maxBatchSize:100,flushIntervalMs:1e4,maxRetries:3,retryBaseMs:1e3};class o{config;buffer=[];flushTimer=null;isFlushing=!1;failedBatches=[];eventsSentThisMinute=0;rateLimitResetTimer=null;deviceFingerprint="";stats={totalSent:0,totalFailed:0,totalDropped:0,totalBatches:0};constructor(e={}){this.config={...r,...e}}async initialize(){this.deviceFingerprint=await this.generateDeviceFingerprint(),this.flushTimer=setInterval(()=>this.flush(),this.config.flushIntervalMs),this.rateLimitResetTimer=setInterval(()=>{this.eventsSentThisMinute=0},6e4),await this.restoreFailedBatches()}enqueue(e){this.eventsSentThisMinute>=1e3?this.stats.totalDropped++:(this.buffer.push(e),this.buffer.length>=this.config.maxBatchSize&&this.flush())}async flush(){if(!this.isFlushing&&0!==this.buffer.length){this.isFlushing=!0;try{const e={events:this.buffer.splice(0,this.config.maxBatchSize),deviceFingerprint:this.deviceFingerprint,batchId:crypto.randomUUID(),sentAt:(new Date).toISOString()};await this.sendBatch(e),await this.retryFailedBatches()}finally{this.isFlushing=!1}}}async sendBatch(e,t=0){if(this.config.endpoint)try{const a=await fetch(this.config.endpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`,"X-Ghost-Batch-Id":e.batchId,"X-Ghost-Device":e.deviceFingerprint},body:JSON.stringify(e)});if(202===a.status||200===a.status)return this.stats.totalSent+=e.events.length,this.stats.totalBatches++,void(this.eventsSentThisMinute+=e.events.length);if(429===a.status){const n=parseInt(a.headers.get("Retry-After")||"60",10);return await this.delay(1e3*n),this.sendBatch(e,t)}if(a.status>=500&&t<this.config.maxRetries)return await this.delay(this.config.retryBaseMs*Math.pow(2,t)),this.sendBatch(e,t+1);this.stats.totalFailed+=e.events.length,this.failedBatches.push(e),await this.persistFailedBatches()}catch(a){if(t<this.config.maxRetries)return await this.delay(this.config.retryBaseMs*Math.pow(2,t)),this.sendBatch(e,t+1);this.stats.totalFailed+=e.events.length,this.failedBatches.push(e),await this.persistFailedBatches()}else this.failedBatches.push(e)}async retryFailedBatches(){const e=this.failedBatches.splice(0);for(const t of e)await this.sendBatch(t)}async persistFailedBatches(){try{if("undefined"!=typeof chrome&&chrome.storage?.local){const e=this.failedBatches.slice(-10);await chrome.storage.local.set({ghost_failed_batches:e})}}catch{}}async restoreFailedBatches(){try{if("undefined"!=typeof chrome&&chrome.storage?.local){const e=await chrome.storage.local.get("ghost_failed_batches");e.ghost_failed_batches&&(this.failedBatches=e.ghost_failed_batches,await chrome.storage.local.remove("ghost_failed_batches"))}}catch{}}configure(e,t){this.config.endpoint=e,this.config.apiKey=t}getStats(){return{...this.stats,bufferSize:this.buffer.length,failedBatchCount:this.failedBatches.length,eventsThisMinute:this.eventsSentThisMinute}}async shutdown(){this.flushTimer&&(clearInterval(this.flushTimer),this.flushTimer=null),this.rateLimitResetTimer&&(clearInterval(this.rateLimitResetTimer),this.rateLimitResetTimer=null),await this.flush(),await this.persistFailedBatches()}delay(e){return new Promise(t=>setTimeout(t,e))}async generateDeviceFingerprint(){const e=["ghost-ext",Intl.DateTimeFormat().resolvedOptions().timeZone,String(navigator?.language??"en"),String(navigator?.hardwareConcurrency??0)].join("|"),t=new TextEncoder,a=await crypto.subtle.digest("SHA-256",t.encode(e));return Array.from(new Uint8Array(a)).slice(0,16).map(e=>e.toString(16).padStart(2,"0")).join("")}}let c=null,l=null,h=!0,d=0,u=0;async function g(){const e=await async function(){return new Promise(e=>{chrome.storage.local.get(["ghost_config","ghost_enabled","ghost_device_id"],t=>{const a=t.ghost_config||{};e({enabled:!1!==t.ghost_enabled,endpoint:a.endpoint||"",apiKey:a.apiKey||"",orgId:a.orgId||"",userId:a.userId||"",deviceId:t.ghost_device_id||""})})})}();h=e.enabled,c=new i(e.orgId||"default_org",e.deviceId||await f(),e.userId||"anonymous"),l=new o({endpoint:e.endpoint||"",apiKey:e.apiKey||"",maxBatchSize:100,flushIntervalMs:1e4,maxRetries:3,retryBaseMs:1e3}),await l.initialize(),console.log("[Ghost] Service worker initialized")}async function f(){const e=await chrome.storage.local.get("ghost_device_id");if(e.ghost_device_id)return e.ghost_device_id;const t=crypto.randomUUID();return await chrome.storage.local.set({ghost_device_id:t}),t}chrome.runtime.onMessage.addListener((e,a,n)=>{switch(e.type){case"RAW_EVENT":!async function(e){if(h&&c&&l){d++;try{const t=await c.process(e);l.enqueue(t),u++}catch(e){console.error("[Ghost] Event processing error:",e)}}}(e.event);break;case"CONTENT_SCRIPT_READY":console.log(`[Ghost] Content script active: ${e.url} (tab: ${e.tabId})`);break;case"SESSION_ROTATED":t.resetCounters(),c&&c.reset();break;case"GET_STATS":return n({totalEventsReceived:d,totalEventsProcessed:u,transmitterStats:l?.getStats(),isEnabled:h}),!0;case"UPDATE_CONFIG":return async function(e){(e.endpoint||e.apiKey)&&l?.configure(e.endpoint||"",e.apiKey||""),(e.orgId||e.userId)&&(c=new i(e.orgId||"default_org",e.deviceId||await f(),e.userId||"anonymous")),await chrome.storage.local.set({ghost_config:e,ghost_enabled:e.enabled??h})}(e.config),n({ok:!0}),!0;case"TOGGLE_ENABLED":return h=e.enabled,chrome.storage.local.set({ghost_enabled:h}),function(e){chrome.tabs.query({},t=>{for(const a of t)a.id&&chrome.tabs.sendMessage(a.id,e).catch(()=>{})})}({type:"TOGGLE_CAPTURE",enabled:h}),n({ok:!0}),!0;case"FORCE_FLUSH":return l?.flush().then(()=>{n({ok:!0,stats:l?.getStats()})}),!0}}),chrome.runtime.onInstalled.addListener(()=>{g()}),chrome.runtime.onStartup.addListener(()=>{g()}),chrome.alarms.create("ghost-keepalive",{periodInMinutes:1}),chrome.alarms.onAlarm.addListener(e=>{"ghost-keepalive"===e.name&&l?.flush()}),g()})();