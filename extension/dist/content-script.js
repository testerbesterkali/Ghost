(()=>{"use strict";class t{fingerprint(t){return{aria:this.extractAria(t),textHash:this.simhash(this.getDirectText(t)),textPreview:this.getDirectText(t).slice(0,200),position:this.getVisualPosition(t),domPath:this.getDomPath(t),tagName:t.tagName.toLowerCase(),context:this.getSurroundingContext(t),inputType:this.getInputType(t),formId:this.getFormId(t)}}extractAria(t){return{role:t.getAttribute("role")||t.role||null,label:t.getAttribute("aria-label")||t.getAttribute("aria-labelledby")||null,describedBy:t.getAttribute("aria-describedby")||null,expanded:this.parseBoolAttr(t,"aria-expanded"),checked:this.parseBoolAttr(t,"aria-checked"),selected:this.parseBoolAttr(t,"aria-selected")}}simhash(t){if(!t)return"0".repeat(32);const e=this.getShingles(t.toLowerCase().trim(),3),s=new Int32Array(128);for(const t of e){const e=this.fnv1a(t);for(let t=0;t<128;t++)e>>t%32&1?s[t]++:s[t]--}let n="";for(let t=0;t<128;t++)n+=s[t]>0?"1":"0";return this.binaryToHex(n)}getShingles(t,e){const s=[];for(let n=0;n<=t.length-e;n++)s.push(t.substring(n,n+e));return s}fnv1a(t){let e=2166136261;for(let s=0;s<t.length;s++)e^=t.charCodeAt(s),e=16777619*e>>>0;return e}binaryToHex(t){let e="";for(let s=0;s<t.length;s+=4)e+=parseInt(t.substring(s,s+4),2).toString(16);return e}getDirectText(t){let e="";for(const s of Array.from(t.childNodes))s.nodeType===Node.TEXT_NODE&&(e+=(s.textContent||"").trim()+" ");return(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement)&&(e+=t.placeholder||""),e.trim()}getVisualPosition(t){const e=t.getBoundingClientRect(),s=window.innerWidth,n=window.innerHeight;return{x:Math.round(e.x),y:Math.round(e.y),width:Math.round(e.width),height:Math.round(e.height),viewportWidth:s,viewportHeight:n,relativeX:s?Math.round(e.x/s*1e3)/1e3:0,relativeY:n?Math.round(e.y/n*1e3)/1e3:0}}getDomPath(t){const e=[];let s=t;for(;s&&s!==document.documentElement;){const t=s.tagName.toLowerCase(),n=s.getAttribute("role"),i=n?`${t}[role=${n}]`:t;e.unshift(i),s=s.parentElement}return e}getSurroundingContext(t){const e=t.parentElement,s=e?Array.from(e.children):[],n=s.indexOf(t);return{parentTag:e?.tagName.toLowerCase()||"none",parentRole:e?.getAttribute("role")||null,parentText:e?this.getDirectText(e).slice(0,100):null,siblingCount:s.length,siblingIndex:n,previousSiblingTag:n>0?s[n-1].tagName.toLowerCase():null,nextSiblingTag:n<s.length-1?s[n+1].tagName.toLowerCase():null}}getInputType(t){return t instanceof HTMLInputElement?t.type:t instanceof HTMLSelectElement?"select":t instanceof HTMLTextAreaElement?"textarea":null}getFormId(t){const e=t.closest("form");return e?e.getAttribute("name")||e.getAttribute("action")||"unnamed-form":null}parseBoolAttr(t,e){const s=t.getAttribute(e);return null===s?null:"true"===s}}class e{observer=null;fingerprinter;onEvent;sessionId;tabId;pendingMutations=[];flushTimer=null;FLUSH_INTERVAL_MS=500;lastSnapshotHash="";constructor(e,s,n){this.fingerprinter=new t,this.onEvent=e,this.sessionId=s,this.tabId=n}start(){this.observer||(this.observer=new MutationObserver(t=>{this.pendingMutations.push(...t),this.flushTimer||(this.flushTimer=setTimeout(()=>this.flush(),this.FLUSH_INTERVAL_MS))}),this.observer.observe(document.body,{childList:!0,attributes:!0,characterData:!0,subtree:!0,attributeOldValue:!0,characterDataOldValue:!0}),this.lastSnapshotHash=this.computeSnapshotHash())}stop(){this.observer&&(this.observer.disconnect(),this.observer=null),this.flushTimer&&(clearTimeout(this.flushTimer),this.flushTimer=null),this.pendingMutations=[]}updateSession(t){this.sessionId=t}flush(){if(this.flushTimer=null,0===this.pendingMutations.length)return;const t=this.pendingMutations.splice(0),e=this.summarizeMutations(t);if(0===e.length)return;const s=this.computeSnapshotHash(),n={timestamp:performance.now(),sessionId:this.sessionId,eventType:"dom_mut",payload:{mutations:e,snapshotHash:s},context:{url:this.normalizeUrl(window.location.href),viewport:{width:window.innerWidth,height:window.innerHeight},userAgent:navigator.userAgent,tabId:this.tabId}};this.lastSnapshotHash=s,this.onEvent(n)}summarizeMutations(t){const e=[],s=new Set;for(const n of t){const t=n.target;if(!(t instanceof Element))continue;if(this.isNoisyMutation(t,n))continue;const i=`${n.type}:${this.getStableKey(t)}:${n.attributeName||""}`;if(!s.has(i)){s.add(i);try{e.push({type:n.type,target:this.fingerprinter.fingerprint(t),addedNodes:n.addedNodes.length,removedNodes:n.removedNodes.length,attributeName:n.attributeName||null,oldValue:n.oldValue?.slice(0,100)||null,newValue:"attributes"===n.type&&n.attributeName&&t.getAttribute(n.attributeName)?.slice(0,100)||null})}catch{}if(e.length>=50)break}}return e}isNoisyMutation(t,e){const s=t.tagName?.toLowerCase();return!!["script","style","link","meta","noscript"].includes(s)||!!t.closest?.("[data-ghost-shadow]")||!("attributes"!==e.type||!e.attributeName||!["class","style"].includes(e.attributeName)||this.isInteractive(t))}isInteractive(t){const e=t.tagName?.toLowerCase();return["input","textarea","select","button","a"].includes(e)||"button"===t.getAttribute("role")||"true"===t.getAttribute("contenteditable")||t.hasAttribute("onclick")}getStableKey(t){return`${t.tagName?.toLowerCase()||"unknown"}:${t.getAttribute("role")||""}:${t.getAttribute("aria-label")||""}`}computeSnapshotHash(){const t=(e,s)=>{if(s>10)return"";let n=e.tagName||"";const i=e.children;for(let e=0;e<Math.min(i.length,20);e++)n+=t(i[e],s+1);return n},e=t(document.body,0);return this.fnv1a(e).toString(16)}fnv1a(t){let e=2166136261;for(let s=0;s<t.length;s++)e^=t.charCodeAt(s),e=16777619*e>>>0;return e}normalizeUrl(t){try{const e=new URL(t);return["utm_source","utm_medium","utm_campaign","fbclid","gclid"].forEach(t=>e.searchParams.delete(t)),`${e.origin}${e.pathname}${e.search}`}catch{return t}}}class s{fingerprinter;onEvent;sessionId;tabId;listeners=[];lastScrollTime=0;SCROLL_THROTTLE_MS=300;constructor(e,s,n){this.fingerprinter=new t,this.onEvent=e,this.sessionId=s,this.tabId=n}start(){this.addListener("click",this.handleClick.bind(this),!0),this.addListener("input",this.handleInput.bind(this),!0),this.addListener("focus",this.handleFocus.bind(this),!0),this.addListener("scroll",this.handleScroll.bind(this),{passive:!0,capture:!0}),this.addListener("copy",this.handleClipboard.bind(this,"copy"),!0),this.addListener("paste",this.handleClipboard.bind(this,"paste"),!0),this.addListener("change",this.handleChange.bind(this),!0),window.addEventListener("popstate",this.handleNavigation.bind(this))}stop(){for(const{type:t,handler:e}of this.listeners)document.removeEventListener(t,e,!0);this.listeners=[],window.removeEventListener("popstate",this.handleNavigation.bind(this))}updateSession(t){this.sessionId=t}addListener(t,e,s){document.addEventListener(t,e,s),this.listeners.push({type:t,handler:e})}handleClick(t){const e=t.target;e&&!this.isGhostElement(e)&&this.emit("click",e)}handleInput(t){const e=t.target;e&&!this.isGhostElement(e)&&(e instanceof HTMLInputElement&&"password"===e.type?this.emit("input",e,"[PASSWORD]"):this.emit("input",e,e.value))}handleFocus(t){const e=t.target;e&&!this.isGhostElement(e)&&this.isInteractive(e)&&this.emit("focus",e)}handleScroll(t){const e=performance.now();e-this.lastScrollTime<this.SCROLL_THROTTLE_MS||(this.lastScrollTime=e,this.emit("scroll",document.documentElement,void 0))}handleClipboard(t,e){const s=document.activeElement;s&&this.emit(t,s)}handleChange(t){const e=t.target;e&&!this.isGhostElement(e)&&e instanceof HTMLSelectElement&&this.emit("select",e,e.value)}handleNavigation(){const t={timestamp:performance.now(),sessionId:this.sessionId,eventType:"user_int",payload:{action:"navigate",value:window.location.href},context:this.getContext()};this.onEvent(t)}emit(t,e,s){try{const n={timestamp:performance.now(),sessionId:this.sessionId,eventType:"user_int",payload:{action:t,target:this.fingerprinter.fingerprint(e),value:s},context:this.getContext()};this.onEvent(n)}catch{}}getContext(){return{url:this.normalizeUrl(window.location.href),viewport:{width:window.innerWidth,height:window.innerHeight},userAgent:navigator.userAgent,tabId:this.tabId}}isGhostElement(t){return!!t.closest?.("[data-ghost-shadow]")}isInteractive(t){const e=t.tagName?.toLowerCase();return["input","textarea","select","button","a"].includes(e)||"button"===t.getAttribute("role")||"true"===t.getAttribute("contenteditable")||t.hasAttribute("tabindex")}normalizeUrl(t){try{const e=new URL(t);return["utm_source","utm_medium","utm_campaign","fbclid","gclid"].forEach(t=>e.searchParams.delete(t)),`${e.origin}${e.pathname}${e.search}`}catch{return t}}}class n{observer=null;onEvent;sessionId;tabId;seenUrls=new Set;cleanupTimer=null;constructor(t,e,s){this.onEvent=t,this.sessionId=e,this.tabId=s}start(){if("undefined"!=typeof PerformanceObserver){this.observer=new PerformanceObserver(t=>{for(const e of t.getEntries())"resource"===e.entryType&&this.handleResourceEntry(e)});try{this.observer.observe({type:"resource",buffered:!1})}catch{this.observer.observe({entryTypes:["resource"]})}this.patchFetch(),this.patchXHR(),this.cleanupTimer=setInterval(()=>{this.seenUrls.clear()},3e5)}}stop(){this.observer&&(this.observer.disconnect(),this.observer=null),this.cleanupTimer&&(clearInterval(this.cleanupTimer),this.cleanupTimer=null)}updateSession(t){this.sessionId=t}handleResourceEntry(t){const e=t.initiatorType;if(!["fetch","xmlhttprequest"].includes(e))return;const s=this.sanitizeUrl(t.name),n=`${s}:${Math.round(t.startTime/1e3)}`;if(this.seenUrls.has(n))return;this.seenUrls.add(n);const i={timestamp:t.startTime,sessionId:this.sessionId,eventType:"network",payload:{url:s,method:"UNKNOWN",statusCode:0,responseType:t.initiatorType},context:{url:this.normalizeUrl(window.location.href),viewport:{width:window.innerWidth,height:window.innerHeight},userAgent:navigator.userAgent,tabId:this.tabId}};this.onEvent(i)}patchFetch(){const t=window.fetch,e=this;window.fetch=async function(...s){const n=s[0],i=s[1];let r="GET",o="";"string"==typeof n?(o=n,r=i?.method||"GET"):n instanceof Request?(o=n.url,r=n.method):o=String(n);try{const n=await t.apply(this,s);return e.emitNetworkEvent(o,r,n.status,"fetch"),n}catch(t){throw e.emitNetworkEvent(o,r,0,"fetch"),t}}}patchXHR(){const t=this,e=XMLHttpRequest.prototype.open,s=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(t,s,...n){return this.__ghost_method=t,this.__ghost_url=String(s),e.apply(this,[t,s,...n])},XMLHttpRequest.prototype.send=function(e){return this.addEventListener("loadend",function(){t.emitNetworkEvent(this.__ghost_url||"",this.__ghost_method||"GET",this.status,"xmlhttprequest")}),s.call(this,e)}}emitNetworkEvent(t,e,s,n){const i={timestamp:performance.now(),sessionId:this.sessionId,eventType:"network",payload:{url:this.sanitizeUrl(t),method:e,statusCode:s,responseType:n},context:{url:this.normalizeUrl(window.location.href),viewport:{width:window.innerWidth,height:window.innerHeight},userAgent:navigator.userAgent,tabId:this.tabId}};this.onEvent(i)}sanitizeUrl(t){try{const e=new URL(t,window.location.origin),s=new URL(e.origin+e.pathname);return e.search&&e.searchParams.forEach((t,e)=>{s.searchParams.set(e,this.hashValue(t))}),s.toString()}catch{return"[INVALID_URL]"}}hashValue(t){let e=2166136261;for(let s=0;s<t.length;s++)e^=t.charCodeAt(s),e=16777619*e>>>0;return e.toString(16)}normalizeUrl(t){try{const e=new URL(t);return`${e.origin}${e.pathname}`}catch{return t}}}class i{onEvent;sessionId;tabId;boundHandlers;constructor(t,e,s){this.onEvent=t,this.sessionId=e,this.tabId=s,this.boundHandlers={error:this.handleError.bind(this),unhandledRejection:this.handleRejection.bind(this)}}start(){window.addEventListener("error",this.boundHandlers.error),window.addEventListener("unhandledrejection",this.boundHandlers.unhandledRejection)}stop(){window.removeEventListener("error",this.boundHandlers.error),window.removeEventListener("unhandledrejection",this.boundHandlers.unhandledRejection)}updateSession(t){this.sessionId=t}handleError(t){this.emit(t.message||"Unknown error",t.error?.stack||"",t.filename||"")}handleRejection(t){const e=t.reason instanceof Error?t.reason.message:String(t.reason),s=t.reason instanceof Error&&t.reason.stack||"";this.emit(e,s,"unhandled-promise")}emit(t,e,s){const n={timestamp:performance.now(),sessionId:this.sessionId,eventType:"error",payload:{message:t.slice(0,500),stack:e.slice(0,1e3),source:s},context:{url:window.location.href,viewport:{width:window.innerWidth,height:window.innerHeight},userAgent:navigator.userAgent,tabId:this.tabId}};this.onEvent(n)}}chrome.runtime.onMessage.addListener((t,e,s)=>("TOGGLE_CAPTURE"===t.type&&(t.enabled?r.start():r.stop(),s({ok:!0})),"GET_STATUS"===t.type&&s({active:!0}),!0));const r=new class{domObserver=null;interactionTracker=null;networkObserver=null;errorObserver=null;sessionId;tabId;isActive=!1;eventCount=0;sessionRotationTimer=null;SESSION_ROTATION_MS=9e5;constructor(){this.sessionId=this.generateSessionId(),this.tabId=this.generateTabId()}async start(){if(!(await this.getConfig()).enabled)return;this.isActive=!0,this.createShadowContainer();const t=this.handleRawEvent.bind(this);this.domObserver=new e(t,this.sessionId,this.tabId),this.interactionTracker=new s(t,this.sessionId,this.tabId),this.networkObserver=new n(t,this.sessionId,this.tabId),this.errorObserver=new i(t,this.sessionId,this.tabId),this.domObserver.start(),this.interactionTracker.start(),this.networkObserver.start(),this.errorObserver.start(),this.sessionRotationTimer=setInterval(()=>{this.rotateSession()},this.SESSION_ROTATION_MS),this.sendToServiceWorker({type:"CONTENT_SCRIPT_READY",tabId:this.tabId,url:window.location.href})}stop(){this.isActive=!1,this.domObserver?.stop(),this.interactionTracker?.stop(),this.networkObserver?.stop(),this.errorObserver?.stop(),this.sessionRotationTimer&&(clearInterval(this.sessionRotationTimer),this.sessionRotationTimer=null)}handleRawEvent(t){this.isActive&&(this.eventCount++,this.sendToServiceWorker({type:"RAW_EVENT",event:t}))}rotateSession(){this.sessionId=this.generateSessionId(),this.domObserver?.updateSession(this.sessionId),this.interactionTracker?.updateSession(this.sessionId),this.networkObserver?.updateSession(this.sessionId),this.errorObserver?.updateSession(this.sessionId),this.sendToServiceWorker({type:"SESSION_ROTATED",sessionId:this.sessionId})}createShadowContainer(){if(document.querySelector("[data-ghost-shadow]"))return;const t=document.createElement("div");t.setAttribute("data-ghost-shadow","true"),t.style.cssText="position:fixed;z-index:2147483647;pointer-events:none;top:0;left:0;width:0;height:0;";const e=t.attachShadow({mode:"closed"}),s=document.createElement("div");s.id="ghost-status",s.style.cssText="\n      position: fixed;\n      bottom: 12px;\n      right: 12px;\n      width: 8px;\n      height: 8px;\n      border-radius: 50%;\n      background: #22c55e;\n      opacity: 0.6;\n      pointer-events: none;\n      transition: opacity 0.3s;\n      z-index: 2147483647;\n    ",e.appendChild(s),document.documentElement.appendChild(t)}sendToServiceWorker(t){try{chrome.runtime.sendMessage(t)}catch{this.stop()}}async getConfig(){return new Promise(t=>{try{chrome.storage.local.get(["ghost_enabled"],e=>{t({enabled:!1!==e.ghost_enabled})})}catch{t({enabled:!1})}})}generateSessionId(){return crypto.randomUUID()}generateTabId(){return`tab_${Date.now()}_${Math.random().toString(36).slice(2,8)}`}};r.start()})();